from __future__ import annotations

from collections import defaultdict
from typing import Dict
from typing import List

from langchain import LLMChain
from langchain import PromptTemplate
from langchain_openai import ChatOpenAI

from jira_telegram_bot.entities.task import TaskData
from jira_telegram_bot.use_cases.interface.summary_generator_interface import (
    ISummaryGenerator,
)
from jira_telegram_bot.use_cases.interface.task_grouper_interface import ITaskGrouper


class TaskGrouper(ITaskGrouper):
    def group_tasks(
        self,
        tasks: List[TaskData],
    ) -> Dict[str, Dict[str, List[TaskData]]]:
        component_groups = defaultdict(lambda: defaultdict(list))
        for task in tasks:
            component_key = (
                task.component if task.component else "no executive department"
            )
            epic_key = task.epics if task.epics else "no epic"
            component_groups[component_key][epic_key].append(task)
        return component_groups


class SummaryGenerator(ISummaryGenerator):
    def __init__(self, llm_chain: LLMChain):
        self.llm_chain = llm_chain

    def generate_summary(
        self,
        grouped_tasks: Dict[str, Dict[str, List[TaskData]]],
    ) -> str:
        summaries = []
        for component, epics in grouped_tasks.items():
            component_summary = f"**executive department: {component}**\n"
            for epic, tasks in epics.items():
                epic_summary = f"  - **epic: {epic}**\n"
                for task in tasks:
                    task_summary = (
                        f"task {task.summary}"
                        f"    - ูุธูู ุชูุณุท {task.assignee} ุจุฑุง ูุณุฎู {task.release} ุงูุฌุงู ุดุฏ. "
                        f"ุฌุฒุฆุงุช: {task.description}\n"
                    )
                    epic_summary += task_summary
                component_summary += epic_summary
            summaries.append(component_summary)
        final_summary = "\n".join(summaries)
        response = self.llm_chain.run(final_summary)
        return response


class TaskProcessor:
    def __init__(
        self,
        llm_chain: LLMChain,
        grouper: ITaskGrouper = None,
        generator: ISummaryGenerator = None,
    ):
        self.grouper = grouper if grouper else TaskGrouper()
        self.generator = generator if generator else SummaryGenerator(llm_chain)

    def process_tasks(self, tasks: List[TaskData]) -> str:
        grouped_tasks = self.grouper.group_tasks(tasks)
        summary = self.generator.generate_summary(grouped_tasks)
        return summary


def create_llm_chain(settings):
    llm = ChatOpenAI(model_name="o3-mini", openai_api_key=settings.token)
    prompt = PromptTemplate(
        input_variables=["grouped_tasks"],
        template="""
     ุดูุง ูุณุช ุงุฒ ูุธุงู ุฏุงุฑุฏ ฺฉู ุจุงุฒุจู ุง ุชฺฉูู ุดุฏูโุงูุฏ:

{grouped_tasks}

ูุฑ ูุธูู ุดุงูู ุงุทูุงุนุงุช ุฒุฑ ุงุณุช:
- Assignee (ุดุฎุต ูุณุฆูู)
- Summary (ุฎูุงุตู ฺฉุงุฑ)
- Component (ุฏูพุงุฑุชูุงูุ ุฏุฑ ุตูุฑุช ูุฌูุฏ)
- Epic (ุงูพฺฉุ ุฏุฑ ุตูุฑุช ูุฌูุฏ)
- Release Version (ูุณุฎู ุงูุชุดุงุฑุ ุฏุฑ ุตูุฑุช ูุฌูุฏ)

ูุทูุงู ฺฉ ุฎูุงุตู ููุง ุจู **ุฒุจุงู ูุงุฑุณ** ุจุฑุง ุงู ูุธุงู ุจููุณุฏ ู ุงุฒ ุฏุณุชูุฑุงูุนููโูุง ุฒุฑ ูพุฑู ฺฉูุฏ:

1. **ฺฏุฑููโุจูุฏ ูุธุงู ุจุฑ ุงุณุงุณ Component (ุฏูพุงุฑุชูุงู)**:
   - ูุฑ ุฏูพุงุฑุชูุงู ุฑุง ุจุง ุนููุงู ยซฺฏุฑููยป ูุดุฎุต ฺฉูุฏ.
   - ุงฺฏุฑ ฺฉ ูุธูู ุฏุงุฑุง ุฏูพุงุฑุชูุงู ูุณุชุ ุขู ุฑุง ุฏุฑ ฺฏุฑูู ุจุง ุนููุงู **ยซุจุฏูู ุฏูพุงุฑุชูุงูยป** ูุฑุงุฑ ุฏูุฏ.

   **ูุซุงู ุณุงุฎุชุงุฑ ฺฉู:**
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   **ฺฏุฑูู: [ูุงู ุฏูพุงุฑุชูุงู]**
   - ุงูพฺฉ: [ูุงู ุงูพฺฉ]
     - [ุฎูุงุตู ฺฉุงุฑ]
       (ูุณุฆูู: [ูุงู ูุณุฆูู]ุ ูุณุฎู: [ุฏุฑ ุตูุฑุช ูุฌูุฏ])
     - [ุฎูุงุตู ฺฉุงุฑ ุฏูู]
       (ูุณุฆูู: [ูุงู ูุณุฆูู]ุ ูุณุฎู: [ุฏุฑ ุตูุฑุช ูุฌูุฏ])
   - **ุฎูุงุตู**: [ุชูุถุญ ูุฎุชุตุฑ ุงุฒ ฺฉุงุฑูุง ุงูุฌุงู ุดุฏู ู ุฏุณุชุงูุฑุฏูุง]
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

2. **ุฒุฑฺฏุฑููโุจูุฏ ูุธุงู ูุฑ ุฏูพุงุฑุชูุงู ุจุฑ ุงุณุงุณ Epic**:
   - ุงฺฏุฑ ฺฉ ูุธูู ุฏุงุฑุง ุงูพฺฉ ุงุณุชุ ุขู ุฑุง ุฏุฑ ุฒุฑฺฏุฑูู ูุฑุจูุท ุจู ุขู ุงูพฺฉ ูุฑุงุฑ ุฏูุฏ.
   - ุงฺฏุฑ ุงูพฺฉ ูุดุฎุต ูุณุชุ ุขู ูุธูู ุฑุง ุฏุฑ ุฒุฑฺฏุฑูู **ยซุจุฏูู ุงูพฺฉยป** ูุฑุงุฑ ุฏูุฏ.

3. **ูุฑูุช ููุงุด ูุธุงู**:
   - ูุฑ ูุธูู ุฑุง ุฏุฑ ฺฉ ุฎุท ูุฌุฒุง ุฐฺฉุฑ ฺฉูุฏ ู ุงุฒ ููุงุฏูุง ุง ุงููุฌโูุง ุจุฑุง ุชูฺฉฺฉ ู ุฌุฐุงุจุช ุงุณุชูุงุฏู ฺฉูุฏ. ุจุฑุง ูุซุงู:
     - ยซโยป ุง ยซโขยป ุง ูุฑ ุงููุฌ ููุงุณุจ ุจุฑุง ุฐฺฉุฑ ูุธูู.
   - ุงฺฏุฑ **ูุณุฎู** ููุฌูุฏ ูุจุงุดุฏ ุง *None* ุจุงุดุฏุ ุจูโฺฉู ุขู ุฑุง ุฐฺฉุฑ ูฺฉูุฏ.
   - ุฏุฑ ุฏุงุฎู ูพุฑุงูุชุฒุ ูุณุฆูู ุฑุง ุจุง ุจุฑฺุณุจ *ูุณุฆูู* ุจุงูุฑุฏุ ู ููุท ุฏุฑ ุตูุฑุช ฺฉู ูุณุฎู ูุนุชุจุฑ ุฏุงุดุชุฏุ ูุณุฎู ุฑุง ูู ุจุงูุฑุฏ.

   **ููููู ูุงูุจ ุจุฑุง ูุฑ ูุธูู**:
[ุนููุงู ูุธูู] (ูุณุฆูู: [ูุงู], ูุณุฎู: [ุฏุฑ ุตูุฑุช ูุฌูุฏ])
ุง:
โ [ุนููุงู ูุธูู] (ูุณุฆูู: [ูุงู], ูุณุฎู: [ุฏุฑ ุตูุฑุช ูุฌูุฏ])


4. **ุฎูุงุตู ูพุงุงู ุฏุฑ ุงูุชูุง ูุฑ ุฒุฑฺฏุฑูู (Epic)**:
- ุจุง ุนููุงู **ยซ๐ ุฎูุงุตูยป** ุง ูุฑ ุนููุงู ููุงุณุจ ุฏฺฏุฑุ ฺฉ ุชูุถุญ ูุฎุชุตุฑ ุจููุณุฏ ฺฉู:
  - ฺู ฺฉุณ ุง ฺู ฺฉุณุงู ุฏุฑ ุงู ฺฏุฑูู ูุนุงูุช ุฏุงุดุชูุฏ.
  - ุชูุฑฺฉุฒ ุงุตู ุชุบุฑุงุช ุง ุจูุจูุฏูุง ฺู ุจูุฏู ุงุณุช.
  - ุฏุณุชุงูุฑุฏูุง ุง ูุชุงุฌ ุงุตู ฺู ุจูุฏูโุงูุฏ.

5. **ุฎูุงุตู ฺฉู ููุง ุฏุฑ ุงูุชูุง ุชูุงู ฺฏุฑููโูุง**:
- ุฏุฑ ุงูุชูุงุ ฺฉ ุฌูุนโุจูุฏ ุงุฒ ฺฉู ูพุฑูฺู ุงุฑุงุฆู ฺฉูุฏ ฺฉู ฺฺฏููู ุฏูพุงุฑุชูุงูโูุง ูุฎุชูู (ุง ุจุฏูู ุฏูพุงุฑุชูุงู) ุฏุฑ ฺฉูุงุฑ ูู ูพุฑูฺู ุฑุง ูพุด ุจุฑุฏูโุงูุฏ.
- ูโุชูุงูุฏ ุงุฒ ุงููุฌโูุง ุจุฑุง ุฌููู ุจุดุชุฑ ุงุณุชูุงุฏู ฺฉูุฏุ ุจุฑุง ูุซุงู:
  ```
  โ ูุชุฌูโฺฏุฑ ฺฉู:
  ูุฑ ฺฏุฑูู ุจุง ุชูุฑฺฉุฒ ุจุฑ ุญุทู ุชุฎุตุต ุฎูุฏ...
  ```
- ุณุงุฎุชุงุฑ ููุงุณุจ ุจุฑุง ุฌุฏุง ฺฉุฑุฏู ูุฑ ฺฏุฑูู ู ุฎูุงุตู ูพุงุงู ุฑุนุงุช ฺฉูุฏ (ุฎุท ุชูฺฉฺฉุ ุงููุฌุ ุง ููุงุฑุฏ ุฏฺฏุฑ).

6. **ูููููโุง ุงุฒ ุงุณุชุงู ุฎุฑูุฌ** (ุจู ุตูุฑุช ุฎูุงุตู):
๐ฐ ุฎูุงุตู ููุง ูุธุงู ูพุฑูฺู ๐ฐ โโโโโโโโโโโโโโโโโโโโโโโโโโโโ ๐ท๏ธ ฺฏุฑูู: ุจุฏูู ุฏูพุงุฑุชูุงู

ุงูพฺฉ: ุจุฏูู ุงูพฺฉ โข [ูุงู ูุธูู] (ูุณุฆูู: [ูุงู], ูุณุฎู: [ุฏุฑ ุตูุฑุช ูุฌูุฏ]) โข [ูุงู ูุธูู ุฏฺฏุฑ] (ูุณุฆูู: [ูุงู], ูุณุฎู: [ุฏุฑ ุตูุฑุช ูุฌูุฏ])

๐ ุฎูุงุตู: ุฏุฑ ุงู ุจุฎุดุ [ูุงู ุงูุฑุงุฏ] ุจุง ุชูุฑฺฉุฒ ุจุฑ [ุญูุฒู] ุชุบุฑุงุช ููู ุงุนูุงู ฺฉุฑุฏูโุงูุฏ ฺฉู ...

โโโโโโโโโโโโโโโโโโโโโโโโโโโโ ๐ท๏ธ ฺฏุฑูู: [ูุงู ุฏูพุงุฑุชูุงู]

ุงูพฺฉ: ุจุฏูู ุงูพฺฉ ...
โ ูุชุฌูโฺฏุฑ ฺฉู: ...


**โ๏ธ ูฺฉุงุช ููู**:
- ุงุฒ **ุงููุฌโูุง** ุจุฑุง ุฌุฐุงุจุช ุงุณุชูุงุฏู ฺฉูุฏ.
- ุงุฒ ุจููุฏ (**...**) ุจุฑุง ุชุชุฑูุง ุง ุนุจุงุฑุงุช ฺฉูุฏ.
- ุงุฒ ุงุชุงูฺฉ (*...*) ุฏุฑ ุตูุฑุช ูุงุฒ ุจุฑุง ุชุฃฺฉุฏ.
- ุงุทูุงุนุงุช ุฑุง ุจูโุตูุฑุช ููุณุฌู ู ฺฉุงููุงู ุฎูุงูุง ุจููุณุฏ.
- ุฏุฑ ุตูุฑุช ุฎุงู ุจูุฏู ุง *None* ุจูุฏู **Release Version**ุ ุงุฒ ููุดุชู ุขู ุตุฑูโูุธุฑ ฺฉูุฏ.

        """,
    )
    llm_chain = LLMChain(llm=llm, prompt=prompt)
    return llm_chain
